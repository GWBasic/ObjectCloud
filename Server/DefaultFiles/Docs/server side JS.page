{"Title":"Secure and High-Performance Storage with Server-Side Javascript","Contents":"<p>In ObjectCloud, server-side Javascript can either be used to add additional methods to an object, or as a general script available through HTTP. &#160;Each technique has different uses.</p><p>When adding methods to an object, the methods provided by ObjectCloud can optionally be disabled. &#160;This allows server-side Javascript to lock down the data in an object and verify all operations in a secure manner. &#160;This is the \"Classes\" technique described below.</p><p>The other technique is to use a .ocjs file and call it directly from HTTP, such as through classical AJAX or as the target of a form. &#160;.ocjs files can be used with both GET and POST requests. &#160;They can return any form of data to the browser, including, but not limited to, JSON, strings, or the results of evaluating a template.</p><p>This document assumes&#160;familiarity&#160;with <a xmlns=\"http://www.w3.org/1999/xhtml\" href=\"/Docs/API.page\">ObjectCloud's Javascript AJAX API</a>.</p><h2>Environmental&#160;Information</h2><p>ObjectCloud uses a multi-process model where Javascript is run in a&#160;separate&#160;process from the main server. &#160;This is to protect the main ObjectCloud process from&#160;infinite&#160;loops and memory management issues that can occur in server-side Javascript. &#160;In the event of one of these issues, the Javascript process is restarted without impacting the server.</p><p>ObjectCloud currently uses the Rhino as a Javascript interpreter, although a long-term goal is to switch to V8.<span style=\"font-style: italic;\">&#160;&#160;</span>Previous versions of ObjectCloud&#160;<a target=\"_blank\" title=\"\" href=\"http://www.codeproject.com/KB/cs/EmbeddingJSCS.aspx\">translated Rhino into a CLR-compliant .dll file</a>, although this approach is no longer used because the multi-process model is faster and more stable.</p><p>Performance issues are discussed at the end of this page.</p><h1>Isolated Scripts: .ocjs files</h1><p>ObjectCloud runs .ocjs files through its server-side Javascript interpreter. &#160;The result of the last statement is returned to the browser. &#160;For security reasons, a .ocjs file must be owned by a member of the Administrators group; ordinary users are prohibited from creating .ocjs files.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><p><b>Note</b>: &#160;<i>A common mistake is to use a return statement at the end of the script. &#160;This will result in an \"invalid return\" error. &#160;Such a&#160;habit&#160;can be hard to break, especially when one has spent a lot of time writing in-browser Javascript functions, Java, C#, C, ect.</i></p></blockquote><h2>Examples:</h2><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><b>Note</b>: <i>Examples are untested!</i></div></blockquote><p>The following script returns the string hello world:<br/></p><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><pre>\"Hello World\";</pre></blockquote><p>The following script returns the sum of the GET arguments a and b. &#160;Note the use of the \"Number()\" conversion function. &#160;This is because all GET arguments are initially strings, and thus Javascript will&#160;concatenate&#160;the strings by default.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><pre>var getArgs = getGet();</pre><pre>Number(getArgs.a) + Number(getArgs.b);</pre></blockquote><p>The following script passes the POST arguments c, d, and e to a template. &#160;It assumes that they were passed using the URLEncoded convention, such as if the script is the target of a POST form.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><pre>var postArgs = getPost();</pre><pre>evaluateTemplate('mytemplate', {c: postArgs.c, d: postArgs.d, e: postArgs.e});</pre></blockquote><p>The following script saves a POSTed string as part of a JSON object in the /storeagearea.json object.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><pre>var storagearea = open('/storagearea.json');</pre><pre>var stored = JSON.parse(storeagearea.ReadAll());</pre><pre>stored.fromuser = getPostContents();</pre><pre>storagearea.WriteAll(JSON.stringify(stored));</pre><pre>\"saved: \" + stored.fromuser;</pre></blockquote><p>ObjectCloud's full API is available. &#160;All functions are documented later in this document.</p><h1>Classes<br/></h1><p>Server-Side Javascript borrows the \"class\" concept from Object-Oriented programming.&#160; All classes are stored in the <a target=\"_blank\" title=\"\" href=\"../Classes\">/Classes</a> folder.&#160; Each class is a text file without an extension that contains Javascript.&#160; When creating a class, the server-side code applies to all files with the same extension as the class name.</p><p>For example, for a class named foo:</p><ul><li>The javascript would be stored in a text file in /Classes/foo</li><li><span style=\"text-decoration: line-through;\">Files</span> Objects named \"file.foo,\" \"xyz.foo,\" and \"blah.foo\" would be handled by the Javascript in /Classes/foo.</li></ul><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">If a folder has a Classes sub-folder, the classes in the sub-folder override any classes in the </span><a style=\"font-style: italic;\" target=\"_blank\" title=\"\" href=\"../Classes\">/Classes</a><span style=\"font-style: italic;\"> folder.</span></p><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">All server-side Javascript files must be owned by a member of the administrators group.</span><br/></p><h2>Encapsulation<br/></h2><p>When a class is created, the <span style=\"text-decoration: line-through;\">file's</span> object's underlying methods are no longer accessible to the web, and therefore, no longer callable through AJAX.&#160; Instead, the Javascript methods are made accessible to the web and AJAX.&#160; The server-side Javascript can, however, can call the underlying methods when storing or retrieving data.&#160; Within server-side Javascript, the underlying <span style=\"text-decoration: line-through;\">file's</span> object's methods are placed into the \"base\" object.</p><p></p><p>To enable access to underlying web-accessible methods, the server-side JavaScript must set some options, as follows:</p><pre style=\"margin-left: 40px; \">var options =<br/>{<br/>   BlockWebMethods: false<br/>};<br/></pre><p style=\"margin-left: 40px; \"><span style=\"font-weight: bold; \">Note:</span>&#160;&#160;<span style=\"font-style: italic; \">Be careful when setting BlockWebMethods to false.&#160; If your server-side JavaScript needs to validate data prior to persisting it, then you could open a potential security hole!</span></p><p></p><h2>Persistence, Isolation, and Run-Time data<br/></h2><p>All data must be persisted by calling the underlying base object.&#160; Data stored in runtime variables is not saved and will be discarded at some point in the future. &#160;All users share the same scope, thus care must be taken to not expose users' private data to other users. &#160;Furthermore, ObjectCloud supports concurrent access to server-side Javascript, thus care must be taken to ensure that errors are not introduced due to threading issues.</p><p>In some cases, it is possible to improve page responsiveness by caching data in server-side Javascript variables. &#160;When doing this, care must be taken to ensure that data is loaded and persisted correctly, as the entire scope, and thus variables in it, can be garbage collected at any time.</p><p>Whenever a server-side Javascript class is modified; upon making a call to an object of that class, all in-memory objects will have their scope destroyed. &#160;This means that, during development, whenever a server-side Javascript class is modified, all in-RAM variables are lost, and there will be a short pause when using the class for the first time while it is compiled.</p><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">Feedback on these constraints is welcome, encouraged, and valued. &#160;Previous versions of ObjectCloud gave each user a private and isolated scope, although this approach is no longer taken due to performance implications.</span><br/></p><h2>Debugging<br/></h2><p>Minimal debugging of server-side Javascript classes is supported.&#160; To debug, append ?Method=GetServersideJavascriptErrors when viewing a file of a given class.&#160; For example, to debug /Classes/foo, visit /MyFiles/myfoo.foo?Method=GetServersideJavascriptErrors</p><p>A rudimentary database program, Whisquil, is provided:&#160; <a target=\"_blank\" title=\"\" href=\"/Shell/Editors/Whisquil.wchtml?Method=ReadAll\">/Shell/Editors/Whisquil.wchtml</a>.&#160; To view a database, visit /Shell/Editors/Whisquil.wchtml?FileName=[file name].&#160; For example, to view /MyFiles/myfoo.foo, visit /Shell/Editors/Whisquil.wchtml?FileName=/MyFiles/myfoo.foo.<br/></p><h2>Exposing a Function to the Web<br/></h2><p>By default, all functions in server-side Javascript are not exposed to the web.&#160; This is to prevent unanticipated behavior if malicious parties call functions that aren't intended for the web.&#160; How ObjectCloud exposes a Javascript function to the web is controlled by setting values on the function.</p><p>For example, from <a target=\"_blank\" title=\"\" href=\"/Classes/ibg\">/Classes/ibg</a>, the following values control how the updateNode function is exposed to the web:</p><pre style=\"margin-left: 40px;\">updateNode.webCallable = \"POST_application_x_www_form_urlencoded\";<br/>updateNode.minimumWebPermission = \"Write\";<br/>updateNode.parser_id = \"number\";<br/>updateNode.webReturnConvention = \"JavaScriptObject\";<br/>function updateNode(id, version, contents, changetag)<br/>{<br/></pre><p>The .webCallable is the only value that is needed to expose a function to the web.&#160; The rest of the values give finer control over how ObjectCloud accesses the function.&#160; These values are described throughout this section.</p><h3>.webCallable<br/></h3><p>All functions that are exposed to the web must have their .webCallable value set.&#160; This value tells ObjectCloud what HTTP method is used, and how the arguments are encoded.&#160; The following are the valid values for .webCallable:</p><ul><li><span style=\"font-weight: bold;\">GET</span>:&#160; Function is called with an HTTP GET.&#160; No arguments are passed.</li><li><span style=\"font-weight: bold;\">GET_application_x_www_form_urlencoded</span>:&#160; Function is called with an HTTP GET.&#160; Arguments are passed as url-encoded values in the URL.</li><li><span style=\"font-weight: bold;\">POST_application_x_www_form_urlencoded</span>:&#160; Function is called with an HTTP POST.&#160; Arguments are passed as url-encoded values in the POST body.</li><li><span style=\"font-weight: bold;\">POST_string</span>:&#160; Function is called with an HTTP POST.&#160; A single value is passed, it is included in the POST body as a string.<br/></li></ul><p>The GET calling conventions should be used for functions that primarily read, and the POST calling conventions should be used for functions that primarily write.&#160; This is due to the HTTP semantics of GET versus POST.&#160; Typically, GET requests aren't supposed to change the server's state; except for inconsequential actions like logging.</p><h3>.minimumWebPermission<br/></h3><h2><span style=\"font-weight: bold;\"></span></h2><p>By default, when a function is exposed to the web, only a person with \"Administer\" permission to the <span style=\"text-decoration: line-through;\">file</span> object can call the function.&#160; The minimum permission can be lowered to \"Write\" or \"Read\" by specifying the .minimumWebPermission.</p><p>The following values are valid for .minimumWebPermission:</p><ul><li><span style=\"font-weight: bold;\">Read</span></li><li><span style=\"font-weight: bold;\">Write</span>&#160; (A person with Write access can also call functions that require Read access)<br/></li><li><span style=\"font-weight: bold;\">Administer</span>&#160; (A person with Administer access can call all functions.)<br/></li></ul><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">In some circumstances, server-side Javascript can call into other objects.&#160; In these circumstances, it can utilize an elevated permission.&#160; This is described in the Elevate() section.&#160; A server-side Javascript function can declare a lower permission with the .minimumLocalPermission value.</span><br/></p><h3>.namedPermissions<br/></h3><p>Sometimes \"Read\", \"Write\", and \"Administer\" aren't fine grained enough to effectively control who can access what function.&#160; Named Permissions allows for more specific permissions for groupings of functions.</p><p>The .namedPermissions value takes a comma-seperated list of valid named permissions for a function.&#160; Any user who has a named permission for the file, is a member of a group that has a named permission for a file, or has such a named permission at a higher-level directory with inhert turned on can call the function.</p><p>TODO:&#160; Setting named permissions is currently undocumented, although it is anticipated that named permissions will require some form of a custom GUI in order to set.<br/></p><h3>.parser_*<br/></h3><p>Sometimes, ObjectCloud needs a hint about what kind of data the function expects in an argument.&#160; By default, ObjectCloud will treat all arguments as strings.&#160; Although Javascript's weak typing system can automatically translate some strings into numbers or booleans, this behavior occasionally introduces non-deterministic behavior and unintended side effects.&#160; The .parser_* values are used in situations where a number, boolean, or JSON-encoded object is expected.&#160; Valid values are:</p><ul><li><span style=\"font-weight: bold;\">number</span>:&#160; ObjectCloud attempts to parse the argument into a double-precision value.&#160; If parsing fails, the string is passed as-is.<br/></li><li><span style=\"font-weight: bold;\">bool</span>:&#160; ObjectCloud attempts to parse the argument into a boolean value.&#160; If parsing fails, the string is passed as-is.<br/></li><li><span style=\"font-weight: bold;\">JSON</span>:&#160; ObjectCloud attempts to decode a JSON-encoded object.&#160; If parsing fails, a 422 (Unprocessable Entity) is returned to the caller.</li></ul><p>For example:</p><pre style=\"margin-left: 40px;\">myfunc.webCallable = \"POST_application_x_www_form_urlencoded\";<br/>myfunc.parser_argAsNum = \"number\";<br/>myfunc.parser_argAsBool = \"bool\";<br/>myfunc.parser_argAsJSON = \"JSON\";<br/>function myfunc(argAsNum, argAsBool, argAsJSON)<br/>{<br/></pre><h3>.webReturnConvention<br/></h3><p>The .webReturnConvention is an optional field that describes how the client will handle the returned data.&#160; ObjectCloud uses .webReturnConvention to help Javascript that runs in the browser parse the results of the server-side call.&#160; Valid values are:</p><ul><li><span style=\"font-weight: bold;\">Primitive</span>:&#160; The function returns a string, number, or boolean.<br/></li><li><span style=\"font-weight: bold;\">JSON</span>:&#160; The function either returns an object, or a string that is a JSON-encoded object.&#160; The browser-side Javascript will get an automatically-decoded object.<br/></li><li><span style=\"font-weight: bold;\">JavaScriptObject</span>:&#160; The function either returns an object, a string that is a\nJSON-encoded object, or Javascript.&#160; This will be eval()-ed and its result passed to the browser-side Javascript.</li><li><span style=\"font-weight: bold;\">Status</span>:&#160; No value is returned to the browser-side Javascript.<br/></li><li><span style=\"font-weight: bold;\">Naked</span>:&#160; The browser-side Javascript gets un-parsed results.<br/></li></ul><p>JSON and JavaScriptObject allow a server-side function to return an object that is transparently serialized and then de-serialized for browser-side Javascript.&#160; There is a speed / security tradeoff, described below.<br/></p><div style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">The difference between JSON and JavaScriptObject is very important.&#160; \"JSON\" will make the browser use Prototype.js's </span><a style=\"font-style: italic;\" target=\"_blank\" title=\"\" href=\"http://www.prototypejs.org/api/string/evalJSON\">String.evalJSON()</a><span style=\"font-style: italic;\"> function to parse the results; \"JavaScriptObject\" will make the browser use </span><a style=\"font-style: italic;\" target=\"\" title=\"\" href=\"http://en.wikipedia.org/wiki/Eval#JavaScript\">eval()</a><span style=\"font-style: italic;\"> to parse the object.&#160; \"JavaScriptObject\" is much faster then \"JSON,\" but it can introduce a security risk.&#160; Only use \"JavaScriptObject\" when returning objects that ObjectCloud will serialize to JSON, or when using strings that are validated to be pure JSON.&#160; Future versions of ObjectCloud might introduce a filter for JSON and rely on eval().&#160; Feedback on this issue is encouraged.</span><br/></div><h1>Calling a Server-Side function from In-Browser Javascript</h1><p>The eventual purpose of server-side Javascript is to save data on the server.&#160; All of the underlying object's functions are placed within the base object.</p><p>For example, <a target=\"_blank\" title=\"\" href=\"/Classes/ibg\">/Classes/ibg</a> turns a name-value pairs <span style=\"text-decoration: line-through;\">file</span> object with a .ibg extension into a linked list.&#160; The function updateNode updates the contents of a node in the linked list.&#160; Prior to updating the node, it loads the node and verifies that the caller has the correct version:</p><pre style=\"margin-left: 40px;\">// updateNode<br/><br/>updateNode.webCallable = \"POST_application_x_www_form_urlencoded\";<br/>updateNode.minimumWebPermission = \"Write\";<br/>updateNode.parser_id = \"number\";<br/>updateNode.webReturnConvention = \"JavaScriptObject\";<br/>function updateNode(id, version, contents, changetag)<br/>{<br/>   var nodeAsString;<br/>   elevate(function()<br/>   {<br/>      nodeAsString = <span style=\"background-color: rgb(255, 255, 51);\">base.Get_Sync(\n      {\n         Name: id\n      });</span><br/>   });<br/>   <br/>   var node = eval('(' + nodeAsString + ')');<br/><br/>   throwExceptionOnForbiddenChange(node, contents);<br/><br/>   if (node.v != version)<br/>      throwWebResultOverrideException(400, \"Wrong version\");<br/><br/>   if (node.c != contents)<br/>   {<br/>      node.c = contents;<br/>      node.v = updateVersionNumber(node.v);<br/>      node.t = changetag;<br/><br/>      nodeAsString = JSON.stringify(node);<br/>      elevate(function()<br/>      {<br/>         <span style=\"background-color: rgb(255, 255, 51);\">base.Set_Sync(\n         {\n            Name: id,\n            Value: nodeAsString\n         });</span><br/>      });<br/>   }<br/><br/>   return node;<br/>}<br/></pre><p>In the above example, the base.Get_Sync() and base.Set_Sync() functions call into the underlying name-value pairs object to persist the node's contents.&#160; Calls to base must be made within the context of an elevate() call, documented later.<br/></p><p>Every effort is made to keep the Javascript API as similar as possible between Javascript that runs in the browser and Javascript that runs on the server. &#160;At this time, however, in-browser Javascript should use the&#160;asynchronous&#160;calling convention, and server-side Javascript should use the synchronous convention.</p><h1>Built-in Metadata</h1><p>The following metadata is available for use at runtime:</p><ul><li><span style=\"font-weight: bold;\">fileMetadata.filename</span>:&#160; The filename of the current object<br/></li><li><span style=\"font-weight: bold;\">fileMetadata.fullpath</span>:&#160; The full path to the current object<br/></li><li><span style=\"font-weight: bold;\">fileMetadata.url</span>:&#160; The full URL to the current object<br/></li><li><span style=\"font-weight: bold;\">hostMetadata.host</span>:&#160; The host name, including \":port\" if the port isn't port 80<br/></li><li><span style=\"font-weight: bold;\">hostMetadata.justHost</span>:&#160; Just the host name without the port<br/></li><li><span style=\"font-weight: bold;\">hostMetadata.port</span>:&#160; The host's port.<br/></li></ul><h1>Additional Built-in Functions</h1><p>Server-side Javascript provides some additional methods to assist in returning more detailed data to the browser and for working with ObjectCloud<br/></p><h2>generateWebResult(status, message)<br/></h2><p>The generateWebResult function allows closer control over the status returned to the browser.&#160; The first argument, status, takes a number that is the status code returned to the browser.&#160; The second argument, which is optional, is the message returned to the client.&#160; ObjectCloud treats the message argument as a string.</p><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">Feedback on how to handle the message is welcome and appreciated.</span><br/></p><h2>throwWebResultOverrideException(status, message)</h2><p>The throwWebResultOverrideExcetion function throws a special kind of exception.&#160; Assuming that this exception isn't caught in the server-side Javascript, when it is thrown into ObjectCloud, it will abort all calls and return the result directly to the browser.&#160; This is useful from within elevate() or callAsOwner().<br/></p><h2>JSON</h2><p>The /API/json2.js is automatically loaded to provide secure JSON functionality.&#160; /API/Prototype.js isn't used in server-side Javascript because it only runs within a browser.<br/></p><h3>JSON.parse(toParse)</h3><p>The parse function is a secure way of parsing a JSON object encoded as a string.&#160; When handling untrusted data, the parse function will not allow a hacker to inject malicious Javascript.</p><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">eval() is much faster then calling parse().&#160; When working with trusted JSON strings, eval() is recommended.</span><br/></p><h3>JSON.stringify()<br/></h3><p>Stringify takes a Javascript object and returns it encoded as a JSON string.<br/></p><h2>lockMe(function)</h2><p>Locks the object and calls the function.&#160; When the function is called, it has exclusive access to the underlying object.<br/></p><h2>elevate(function)</h2><p>Calls the function with an elevated security context.&#160; When calling into other objects, the \"minimumLocalPermission\" instead of \"minimumWebPermission\" will be used.&#160; See the later section, \"Calling into other Objects,\" to learn how to call into other objects.</p><p>elevate must be used to call into the base object.<br/></p><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">Validate all input before calling this function, as a malicious user could gain access to sensitive data or corrupt sensitive data</span>.<br/>\n</p>\n<h2>callAsOwner(function)</h2><p>Calls the function as if the object's owner is calling it.</p><p style=\"margin-left: 40px;\"><span style=\"font-weight: bold;\">Note</span>:&#160; <span style=\"font-style: italic;\">Validate all input before calling this function, as a malicious user could gain access to sensitive data or corrupt sensitive data</span>.<br/></p><h2>sanitize(html)</h2><p>Sanitizes the passed in html.&#160; Removes potential cross-site scripting attacks and unclosed tags.&#160; This should be called on all HTML that is displayed to the user.<br/></p><h3 style=\"font-size: 1.1em; font-weight: bold; \">getConnectionMetadata()</h3><p>Returns an object with metadata about the current connection, including the current user and IP. &#160;Returns an object with the following properties:</p><p></p><ul><li><span style=\"font-weight: bold; \">id</span>:&#160; The current user's ID<br/></li><li><span style=\"font-weight: bold; \">name</span>:&#160; The current user's name<br/></li><li><span style=\"font-weight: bold; \">identity</span>:&#160; The current user's OpenID<br/></li><li><b>isLocal</b>: &#160;True if the user is local</li><li><b>remoteEndPoint</b>: &#160;The user's IP<br/></li></ul><p></p><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><p><b>Note:</b>&#160;&#160;<i>For the best CPU utilization, try to only call this function once within a server-side Javascript function. &#160;Repeatedly calling this function can lead to high CPU utilization and slower performance.</i></p></blockquote><h3 style=\"font-size: 1.1em; font-weight: bold; \">getGet()</h3><h3><span class=\"Apple-style-span\" style=\"font-weight: normal; font-size: 16px; \">Returns all of the current GET parameters as a JavaScript object.</span><br/></h3><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><pre>var foo = getGet().Foo;</pre></blockquote><h3 style=\"font-size: 1.1em; font-weight: bold; \">getPost()</h3><p>Returns all of the current POST parameters as a JavaScript object. &#160;In order for this function to work, the current web request must have passed urlencoded POST parameters, such as when a form uses POST. &#160;In the event that there are no POST parameters, null will be returned.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 40px; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; \"><pre>var foo = getPost().Foo;</pre></blockquote><h3 style=\"font-size: 1.1em; font-weight: bold; \">getPostContents()</h3><p>Returns the POSTed data as a string. &#160;In the event that this isn't a POST request, null is returned.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 40px; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; \"><pre>var request = JSON.parse(getPostContents());</pre></blockquote><h3 style=\"font-size: 1.1em; font-weight: bold; \">getHeaders() &#160;[untested]<br/></h3><p>Returns all of the current headers as a JavaScript object.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 40px; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; \"><pre>var foo = getHeaders().Foo;</pre></blockquote><blockquote class=\"webkit-indent-blockquote\" style=\"margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 40px; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; \"><p><b>Note</b>: &#160;<i>This function is untested</i></p></blockquote><h3 style=\"font-size: 1.1em; font-weight: bold; \">getCookies() &#160;[untested]</h3><p>Returns all of the current cookies from the browser parameters as a JavaScript object.</p><blockquote class=\"webkit-indent-blockquote\" style=\"margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 40px; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; \"><pre>var foo = getCookies().Foo;</pre></blockquote><blockquote class=\"webkit-indent-blockquote\" style=\"margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 40px; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; \"><p><b>Note</b>: &#160;<i>This function is untested</i></p></blockquote><h3>setCookie(name, value)<br/></h3><p>Sets the cookie in the browser. &#160;Currently, there is no way to set the expiration, path, or secure setting.</p><div><p></p><blockquote class=\"webkit-indent-blockquote\" style=\"margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 40px; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; \"><p><b>Note</b>: &#160;<i>This function is untested</i></p></blockquote><h3>use(filename)</h3><p>Loads the given Javascript file if it hasn't already been loaded. &#160;Returns any results generated from executing the given Javascript file. &#160;The first time this is called, the results are cached and re-returned. &#160;The user must have read permission to the file, unless this is called from within the context of callAsOwner, in which case the owner must have read permission to the file.</p><p>If the javascript file can not be loaded, no exception occurs. &#160;False is returned.</p><p></p><h3 style=\"font-size: 1.1em; font-weight: bold; \">open(filename)</h3><p>Returns a wrapper that allows accessing the given object. &#160;This is similar to using the // Scripts: syntax, except that it's supported at runtime.</p><p>If the javascript file can not be loaded, no exception occurs. &#160;False is returned.</p><p>For more information on using an opened object, see <a xmlns=\"http://www.w3.org/1999/xhtml\" href=\"/Docs/API/Overview.wchtml\">ObjectCloud's API documentation</a>.</p><p></p><h3 style=\"font-size: 1.1em; font-weight: bold; \">getBrowserCacheUrl(url)</h3><p>Returns a modified version of the given URL that instructs the browser to cache the returned object for a very long time.</p><p>This is a powerful function for improving performance and reducing load on a server. &#160;How it works is that it calculates the MD5 of the result of the given URL, and then appends a \"BrowserCache=...\" parameter to the url. &#160;When the server sees a request with BrowserCache in the url, it instructs the browser to cache the result for a very long time. &#160;This allows a page to display images, reference css, ect, without requiring the browser to download the content every time it is displayed.</p><p>In the event that the content at the given url changes, the MD5 will change, and thus force the browser to reload it.</p><p>Future versions of ObjectCloud may change algorithms to reduce CPU load.</p><p></p><h3 style=\"font-size: 1.1em; font-weight: bold; \">Shell(webMethodString, url, contentType, postArguments, options)</h3><p>Returns the result of calling the given url on the server.</p><p></p><ul><li><b>webMethodString</b>: &#160;Either POST or GET</li><li><b>url</b>: &#160;The url to resolve</li><li><b>contentType</b>: &#160;The contentType. &#160;Only used for POST. &#160;Typically&#160;'application/x-www-form-urlencoded'</li><li><b>postArguments</b>: &#160;The post arguments. &#160;Typically a JSON object when&#160;'application/x-www-form-urlencoded' is the contentType; although this can be a raw string or JSON for POST endpoints that don't use urlencoded data</li><li><b>options</b>: &#160;JSON object that takes additional options. &#160;Currently the only supported option is EncodeAsBase64. &#160;When EncodeAsBase64 is set to true, the result is a base64 encoded string. &#160;This allows for handling binary data, like images.</li></ul>The returned object, (except when using EncodeAsBase64,) has the following properties:<p></p><p></p><ul><li><b>Status</b>: &#160;HTTP status code.</li><li><b>Content</b>: &#160;The content. &#160;Warning, if the content is binary data, like an image, it will be corrupted.</li><li><b>Headers</b>: &#160;HTTP headers.</li></ul><p></p><h3>evaluateTemplate(template, arguments)</h3><p>Evaluates the specified template. &#160;If the arguments argument is included, each named value is passed into the template. &#160;For example, the following evaluates the template /mytemplate.oc with the arguments a, b, and c:</p></div><blockquote class=\"webkit-indent-blockquote\" style=\"margin: 0 0 0 40px; border: none; padding: 0px;\"><div><pre>evaluateTemplate('/mytemplate.oc', {a: 'aaaa', b: 'bbb', c: 'cc'});</pre></div></blockquote><div><h2>Calling into other Objects</h2><p></p><p>Server-side Javascript uses the same // Scripts: syntax that client-side Javascript uses.&#160; This allows another object to be loaded.&#160; For example, from <a target=\"_blank\" title=\"\" href=\"/Tests/Classes\">/Tests/Classes</a>:</p><pre style=\"margin-left: 40px;\">// Scripts: /System/Proxy?Method=GetServersideJavascriptWrapper&amp;assignToVariable=Proxy<br/></pre><p>The method GetServersideJavascriptWrapper returns an object that grants access to the <a target=\"_blank\" title=\"\" href=\"/System/Proxy\">/System/Proxy</a> object by creating the \"Proxy\" object in the server-side Javascript.&#160; An example of accessing the \"Proxy\" object is:</p><pre style=\"margin-left: 40px;\">TestElevateProxyGet.webCallable = \"GET\";<br/>function TestElevateProxyGet()<br/>{<br/>   return elevate(function()<br/>   {<br/>      return <span style=\"background-color: rgb(255, 255, 51);\">Proxy</span>.GET(\"http://slashdot.org\", {}).Content;<br/>   });<br/>}<br/></pre><p>In the above example, the Proxy object is used to make a GET request to http://slashdot.org.&#160; The <a target=\"_blank\" title=\"\" href=\"../System/Proxy\">/System/Proxy</a> requires elevated security in order to call.</p><h1>Performance Issues</h1><p>In general, server-side Javascript is compiled and runs rather quickly. &#160;There are some constraints which are best understood by briefly describing ObjectCloud's Javascript execution environment.</p><p>When ObjectCloud starts, it compiles all classes stored in the global /Classes folder. &#160;This takes a second or so, and is generally fast on a modern multi-core computer. &#160;In the event that server-side Javascript takes more then 10-15 seconds to return, ObjectCloud kills the process. &#160;Every time server-side Javascript calls the ObjectCloud API, the counter is reset. &#160;Therefore, long-running CPU-intense server-side Javascript, such as calculating&#160;fibonacci&#160;sequences, primes, brute-force encryption key breaking, ect should be avoided. &#160;As of this writing, it is possible to be stuck in an unstoppable&#160;infinite&#160;loop that repeatedly calls an ObjectCloud API function.</p><p>Another performance constraint has to do with how ObjectCloud manages memory. &#160;It's impractical to hold all objects in RAM. &#160;ObjectCloud utilizes a first-in, last-out algorithm for memory&#160;reclamation. &#160;This means that less-used objects will have their Javascript scopes destroyed when they are garbage collected. &#160;Furthermore, construction of object's scopes happens on-demand. &#160;Thus, using an object that isn't in RAM incurs about a 1/10th of a second delay. &#160;As a result, pages and applications that use objects that are most likely to be in RAM will perform faster then pages and applications that use objects that are unlikely to be in RAM. &#160;Specifically, applications and pages that primarily consume new user-created data will be fast and&#160;instantaneous; but applications and pages that use old data will be slower and require more RAM.</p></div>"}