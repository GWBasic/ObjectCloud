// Scripts: /Users/UserDB?Method=GetJSW&assignToVariable=UserDB
// FileType: database

getMembers.webCallable = "GET";
getMembers.minimumWebPermission = "Read";
function getMembers()
{
   var toReturn;

   callAsOwner(function()
   {
      var groupId = base.PostQuery_Sync(
         {
            query: "select Value from metadata where Name='GroupId'"
         })[0][0].Value;

      toReturn = UserDB.GetUsersInGroup_Sync(
         {
            groupid: groupId
         });
   });

   return toReturn;
}

getGroup.webCallable = "GET";
getGroup.minimumWebPermission = "Read";
function getGroup()
{
   var groupId;

   callAsOwner(function()
   {
      groupId = base.PostQuery_Sync(
         {
            query: "select Value from metadata where Name='GroupId'"
         })[0][0].Value;
   });

   return UserDB.GetGroupAndAlias_Sync(
      {
         groupid: groupId
      });
}

joinGroup.webCallable = "POST_application_x_www_form_urlencoded";
joinGroup.minimumWebPermission = "Read";
function joinGroup()
{
   var group = getGroup();

   // Only let people join if the group is public
   if (group.Type != "Public")
      throwWebResultOverrideException(403, "This group is not public.  Contact the owner to join.");

   if ("anonymous" == userMetadata.name)
      throwWebResultOverrideException(403, "You must be logged in to join a group");

   var toReturn;

   callAsOwner(function()
   {
      toReturn = UserDB.AddUserToGroup_Sync(
         {
            groupid: group.Id,
            userid: userMetadata.id
         });
   });

   return toReturn;
}
leaveGroup.webCallable = "POST_application_x_www_form_urlencoded";
leaveGroup.minimumWebPermission = "Read";
function leaveGroup()
{
   var group = getGroup();

   // Only let people join if the group is public
   if (group.Type != "Public")
      throwWebResultOverrideException(403, "This group is not public.  Contact the owner to leave.");

   var toReturn;

   callAsOwner(function()
   {
      toReturn = UserDB.RemoveUserFromGroup_Sync(
         {
            groupid: group.Id,
            userid: userMetadata.id
         });
   });

   return toReturn;
}